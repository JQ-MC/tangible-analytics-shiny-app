---
title: "Shiny"
author: "Joaquim Morera"
date: "2/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}


#remat final
#https://deanattali.com/blog/advanced-shiny-tips/#plot-spinner

library(shiny)
library(shinyWidgets)
library(shiny.i18n)

library(knitr)
library(markdown)
library(rmarkdown)
library(stringr)
library(gsubfn)
library(webshot)
library(RMySQL)
library(zip)
library(mailR)
library(dplyr)
library(tidyr)
library(wordcloud2)
library(magrittr)
library(tm)
library(quanteda)
library(ggplot2)
library(readr)
library(lubridate)
library(textcat)
library(htmlwidgets)
library(blastula)
library(keyring)
library(tidytext)
library(cluster)
library(lsa)
library(ggtext)
library(magick)



#imatge del correu
img<-add_image(file = "./needs/logo.png",
               align = "left",
               width = 200)


load("./needs/stop_words.R")     #save(stop_words, file="../needs/stop_words.R")

load("./needs/emojis_dataset.R")
load("./needs/labels_emoji.R")
load("./needs/sent_emoji.R")
load("./needs/paletes_color.R")
load("./needs/colors_hores.R")



#load("C:/Users/quimm/Desktop/A Saber/Axat/Versio_4/test/dos_persones.R")

FREQ<-c(634,501,445,379,372,326,321,316,313,269,269,258,257,256,253,251,239,234,233,232,226,220,205,190,184,184,183,180,177,172,172,170,168,167,161,160,158,151,147,142,141,140,140,139,135,134,134,133,131,129,126,124,122,121,119,119,117,114,113,112,112,111,105,105,104,102,100,99,97,96,96,96,92,92,91,91,90,89,89,89,89,89,88,88,88,87,85,84,84,83,83,82,82,79,77,77,77,76,76,75,75,75,75,75,75,75,75,75,75,75,74,74,74,74,74,74,74,74,74,74,73,73,73,73,73,73,73,73,73,73,72,72,72,72,72,72,72,72,72,72,71,71,71,71,71,71,71,71,71,71,70,70,70,70,70,70,70,70,70,70,69,69,69,69,69,69,69,69,69,69,68,68,68,68,68,68,68,68,68,68,67,67,67,67,67,67,67,67,67,67,66,66,66,66,66,66,66,66,66,66)
unwanted_array = list(    'Š'='S', 'š'='s', 'Ž'='Z', 'ž'='z', 'À'='A', 'Á'='A', 'Â'='A', 'Ã'='A', 'Ä'='A', 'Å'='A', 'Æ'='A', 'Ç'='C', 'È'='E', 'É'='E',
                          'Ê'='E', 'Ë'='E', 'Ì'='I', 'Í'='I', 'Î'='I', 'Ï'='I', 'Ñ'='N', 'Ò'='O', 'Ó'='O', 'Ô'='O', 'Õ'='O', 'Ö'='O', 'Ø'='O', 'Ù'='U',
                          'Ú'='U', 'Û'='U', 'Ü'='U', 'Ý'='Y', 'Þ'='B', 'ß'='Ss', 'à'='a', 'á'='a', 'â'='a', 'ã'='a', 'ä'='a', 'å'='a', 'æ'='a', 'ç'='c',
                          'è'='e', 'é'='e', 'ê'='e', 'ë'='e', 'ì'='i', 'í'='i', 'î'='i', 'ï'='i', 'ð'='o', 'ñ'='n', 'ò'='o', 'ó'='o', 'ô'='o', 'õ'='o',
                          'ö'='o', 'ø'='o', 'ù'='u', 'ú'='u', 'û'='u', 'ý'='y', 'ý'='y', 'þ'='b', 'ÿ'='y' )


```


```{r}


i18n <- Translator$new(translation_json_path = "./needs/translations.json")
i18n$set_translation_language("cast")

```



```{r}


values<- reactiveValues()
  values$idioma<-"val"


ui <- fluidPage(
  
  #per a que funcionen les traduccions
  shiny.i18n::usei18n(i18n),
  
  #css
  tags$head(
    tags$link(rel = "stylesheet", type = "text/css", href = "./www/style.css")
  ),
  includeCSS("./www/style.css"),
  tags$head(tags$style(HTML(my_css))),
  
  
  # ---------------------------- UI
  fluidRow(
    #Espai
    column(3,
           tags$br(), 
           
           #SelectInput Idioma des del panell superior esquerre
           uiOutput("idioma_display")),
    
    column(7, offset = 1,
           
           #titol
           titlePanel("Personalitza la conversa!"),
           
           #Pujada del fitxer
           #tags$h4(i18n$t("Pujada de la conversa:")),
           fileInput(inputId = "upload", 
                     label = i18n$t("Pujada de la conversa:"),
                     accept="text/plain",
                    multiple = FALSE),
           
           
           # Idioma Analytics
           tags$h3("ANALYTICS"),
           uiOutput("idioma_analytics"),
           
           tags$br(), 
           # ------------------- INPUTS PER A PERSONALITZAR LA CONVERSA
           tags$h3("TANGIBLE"),
           tags$h4("Escull ara de quina manera vols Tangibilitzar la conversa amb imatges dels apartats següents:"),
           tags$br(),
           #-------- EN UNA
           checkboxInput("EN_UNA", label = i18n$t("La conversa EN UNA imatge")),
           conditionalPanel(
             condition = "input.EN_UNA == true",   #condicio
             radioGroupButtons(
               inputId = "T",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- 24 HORES
           checkboxInput("HORES", label = i18n$t("24 HORES de la conversa")),
           conditionalPanel(
             condition = "input.HORES == true",   #condicio
             radioGroupButtons(
               inputId = "H",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),

           #-------- ANYS
           checkboxInput("ANYS", label = i18n$t("ANYS de la conversa")),
           conditionalPanel(
             condition = "input.ANYS == true",   #condicio
             radioGroupButtons(
               inputId = "A",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- PERSONES
           checkboxInput("PERSO", label = i18n$t("PERSONES de la conversa")),
           conditionalPanel(
             condition = "input.PERSO == true",   #condicio
             radioGroupButtons(
               inputId = "P",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- EMOJIS
           checkboxInput("EMOJIS", label = i18n$t("EMOJIS de la conversa")),
           conditionalPanel(
             condition = "input.EMOJIS == true",   #condicio
             radioGroupButtons(
               inputId = "E",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           # ---------------- EMAIL I ENVIAMENT
           tags$br(),
           
           textInput("email","Correu electrònic:"),
           
           awesomeCheckbox(
             inputId = "accept",
             label = "Vols inscriure't a la nostra Newsletter per a estar atenta al progrés del projecte i saber les últimes novetats?",
             value = TRUE,
             status = "info",
              width = "95%"
             ),
           
           tags$br(),
           
           actionButton("enviar", " Preparar i enviar comanda! ", class = "btn-primary btn-lg" ),
          
           
           tags$br(), tags$br(),tags$br(), tags$br(),tags$br(), tags$br()
           
           ) #fi mainPanel
    )
  )






server = function(input, output, session) {
  
  
  # -------------------------------------------------------------- IDIOMA I TRADUCCIONS
  
  #Llegim el fitxer amb les traduccions
  i18n <- Translator$new(translation_json_path = "./needs/translations.json")

    # Show modal al principi d'entrar
  showModal(modalDialog(
      title = HTML("<div style='text-align: center;'>IDIOMA / LANGUAGE</div>"),
        HTML("<div style='text-align: center;'>VAL - Escull l'idioma de la sessió<br><br>
        CAST - Escoge el idioma de la sesión<br><br>ENG - Choose the session language<br><br></div>"),
        
        radioGroupButtons(
          inputId = "idioma",
          choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
          justified = TRUE,
          checkIcon = list(
            yes = tags$i(
              class = "fa fa-check-square", 
              style = "color: rgb(0,166,90)"
),
            no = icon("square-o"))),
        footer = tagList(
          actionButton("ok", "OK")
        )
      ))
    
    # When OK button is pressed, es tanca la pantalla emergent
    observeEvent(input$ok, {

      values$idioma<-input$idioma
      #canviem l'idioma que ha seleccionat  
      update_lang(session, isolate(values$idioma))
        
      #llevem la pestanya emergent
      removeModal()
      
      #posem el seleccionador en la pg
      output$idioma_display<-renderUI(
        
      selectInput(
             inputId='idioma2',
             label=i18n$t("Canviar l'idioma"),
             choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
             selected = isolate(values$idioma),
             width = "45%")
      )
      
      output$idioma_analytics<-renderUI(
        selectInput(
             inputId='idioma_analytics',
             label=i18n$t("Tria l'idioma de l'Analytics"),
             choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
             selected = isolate(values$idioma))
      )
      
      
    })
    
    # Per si es vol canviar l'idioma una vegada desapareix el popup
    observeEvent(input$idioma2, {
      values$idioma<-input$idioma2
      
    update_lang(session, isolate(values$idioma))
  })

    #------------- Quan s'apreta el boto enviar. se desencadena tot
    
    observeEvent(input$enviar, {
      
      #Requeriments. queda millorar
      req(input$email, input$upload)
      

      #creacio de la barra de progres
      progress <- shiny::Progress$new()
      progress$set(message = "Preparant Comanda", value = 0)
    # Close the progress when this reactive exits (even if there's an error)
      on.exit(progress$close())
      
      progress$inc(amount = 1/5, detail = "Llegint i estructurant el xat!")
      
      Sys.sleep(200)
      
      
      #-------------------------- ACCIONS SOBRE EL FITXER
      
      #rebem el df del fitxer
      #file<-input$upload
      
      #llegim el fitxer
      #xat<-infolectura_fitxer(file$datapath, input, progress)

      #cat("jasta!")
      #progress$inc(amount = 1/5, detail = "Tot en ordre! Revisa el correu!")
            
      
      showModal(modalDialog(
        title = HTML("<div style='text-align: center;'>FELICITATS!</div>"),
        HTML("<div style='text-align: center;'>Acabes de convertir una relació en Tangible!<br><br>En breus moments rebràs al correu la teua comanda<br><br><br>El xat que ens acabes de proporcionar ja ha estat eliminat dels nostres servidors, així com la comanda associada!<br></div>"),
        easyClose = TRUE,
        footer = tagList(
          actionButton("ok2", "OK")
        )
      ))
      

      
      
      })

    #Eliminar el modal
    observeEvent(input$ok2, {
      #llevem la pestanya emergent
      removeModal()
    
  })
    
}




shinyApp(ui, server)

```


# funcions

```{r}





infolectura_fitxer<- function(nom_xat, input, progress){
  
  "
  Llig el fitxer i el retorna estructurat si es correcte. Si no, retorna 'problema_xat' i es notifica
  
  
  "

    #Lectura del fitxer
    f <- read.delim(file=nom_xat, quote = "" , encoding = "UTF-8", header = F, colClasses = "character")
    
    #llevem les linies repetides
    f<-unique(f)
    
    #Distincio entre IOS i la RESTA. IOS té "[]".
    if (grepl(f[1,1],pattern= "\\[.*\\]")){       #És IOS. Arxius i audios omesos tenen un caracter especial al principi
      
      #guardem el tipus de l'estructura
      tipus<-"IOS"
      
      
      #açò se pot abreviar en la versió online
      ########################################################################################
      #Mirem quins tenen l'estructura. Servix per a /n i missatges de grup
      f<- f %>% mutate(estructura=grepl(pattern="\\[\\d*\\/.*\\]",V1))  #ESTRUCTURA: tipus "[num/algo]"
      
      #Agafem sols els que seguixen l'esquema general
      estructura_false<- f %>% filter(estructura==F)
      f<- f %>% filter(estructura==T)
      ########################################################################################
      
      
      #Idioma
      #Determinem idioma                            #Son els que no comencem per [, ja que la multimedia comensa per un caracter especial
      if(any(grepl("omitido|omitida", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"spanish"
        
      }else if(any(grepl("omès|omesa", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"catalan"
        
      }else if(any(grepl("omitted", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"english"
        
      }else {
        idioma_movil<-"x"
      }
      
      
      #Busquem si té coma entre [], si en té assumim que és ANGLÉS
      if (idioma_movil=="english"){  
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\[", into=c("res", "V1"), extra="merge") %>%
          select(-res)%>% #Servix per a llevar-nos un element que sols té IOS en audios, imatges
          separate(V1, "\\] ", into=c("temps", "resta"), extra="merge") %>%  
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge") %>%
          separate(temps, "\\,", into = c("data", "hora"), extra="merge") %>%
          select(-estructura)
        
        #Per als fs que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        #Adaptem el tipus de dada
        f$data<- as.Date(f$data, format="%d/%m/%Y")
        f$hora<-parse_time(f$hora, format= "%H:%M:%S" )
        f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
        f$usuari<-as.factor(f$usuari)
        
        
        
        
      }else if(idioma_movil=="spanish" | idioma_movil=="catalan") {#No és ANGLÉS
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\[", into=c("res", "V1"), extra="merge") %>%
          select(-res)%>%
          separate(V1, "\\] ", into=c("temps", "resta"), extra="merge") %>%  
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge") %>%
          separate(temps, "\\s", into = c("data", "hora"), extra="merge")%>%
          select(-estructura)
        
        #Per als fs que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        #Adaptem el tipus de dada
        f$data<- as.Date(f$data, format="%d/%m/%y")
        f$hora<-hms(f$hora )
        f$hora2<-as.integer(hour(f$hora))  #Ho necessita el plot del temps x hores
        f$usuari<-as.factor(f$usuari)
        
        
        
      }
    }else{ #No és IOS. RESTA 
      
      #guardem el tipus de l'estructura
      tipus<-"resta"
      
      
      #Afegim el valor estructura, per si seguix l'estructura que voliem:  num/num/num algo num:num algo -espai algo:
      f<- f %>% mutate(estructura=grepl(pattern="^\\d*\\/\\d*\\/\\d*.*\\d*\\:\\d*.*\\-\\s.*\\:",V1)) 
      
      #Agafem sols els que seguixen l'esquema general i guardem els que no
      estructura_false<- f %>% filter(estructura==F)
      f<- f %>% filter(estructura==T)
      
      
      #ANgles i Catala tenen una coma entre data i hora!!!!!!
      if (grepl("^\\d*\\/\\d*\\/\\d*\\,\\s*\\d*\\:\\d*.*\\-\\s.*\\:", f$V1[1])){ #el primer Té coma. És català o anglés
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\,", into=c("data", "resta"), extra="merge") %>%  
          separate(resta, "\\- ", into = c("hora", "resta"), extra="merge") %>%
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge")
        
        
        #Per als xats que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        
        #Determinem idioma_movil
        if(any(grepl("\\<Fitxers multimèdia omesos\\>", f$comm))){
          idioma_movil<-"catalan"
        }else if(any(grepl("\\<Media omitted\\>", f$comm))){
          idioma_movil<-"english"
          
        }else{
          idioma_movil<-"x"
        }
        
        
        #Adaptament al tipus de dada per idioma_movil
        if (idioma_movil=="catalan"){
          
          if(!grepl(pattern = "[ap]\\..m\\.", f[1,2] )){  #ANDROID
            
            #Adaptem el tipus de dada
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora<-hm(f$hora)
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }else{  #HUAWEI
            
            #substituim el p.m i tal
            f$hora<-gsub("p\\..m\\.","PM",f$hora)
            f$hora<-gsub("a\\..m\\.","AM",f$hora)
            
            
            #Adaptem el tipus de dada
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }
          
        }else if(idioma_movil=="english"){#és anglés
          
          #Data
          if (length(f[1, 1])==10){ #Si el valor de l'any té 4 digits. Seguix estructura %d/%m/%Y
            f$data<- as.Date(f$data, format="%d/%m/%Y")
            
          }else{ 
            f$data<- as.Date(f$data, format="%d/%m/%y")
          }
          
          #Hora
          if(grepl("M",f[1,2])){ #Si té AM o PM
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
          }else{
            f$hora<-hm(f$hora)
            
          }
          
          f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
          f$usuari<-as.factor(f$usuari)
          
        }
      }else{  #Es castella
        
        #Determinem idioma_movil
        if(any(grepl("\\<Multimedia omitido\\>", f$V1))){
          
          idioma_movil<-"spanish"
          
          
          #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
          f<-f%>% separate(V1, "\\s", into=c("data", "resta"), extra="merge") %>%  
            separate(resta, "\\- ", into = c("hora", "resta"), extra="merge") %>% #l'espai!!!
            separate(resta, "\\:", into = c("usuari", "comm"), extra="merge")
          
          #Per als fs que seguixen parcialment l'estructura. Llevar-los
          f<-f %>% filter(comm != "NA")
          
          
          if(!grepl(pattern = "[ap]\\..m\\.", f[1,2] )){  #ANDROID
            
            #Adaptem el tipus de dada
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora<-hm(f$hora)
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }else{ #HUAWEI
            
            #substituim el p.m i tal
            f$hora<-gsub("p\\..m\\.","PM",f$hora)
            f$hora<-gsub("a\\..m\\.","AM",f$hora)
            
            
            #Adaptem el tipus de dada
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }
          
        }else{
          idioma_movil<-"x"
        }
        
        
      }
    }
    
    
    if (tipus=="IOS"){
      # En els IOS, quan reenvies missatges, es copien igual amb la mateixa estructura pero no tenen els SEGONS I ANYS, i ixen NA. emprem complete cases per a canviar-ho.
      #[9/2/19 1:58:05] Etarra: [9/2 1:55] Olatz: En casa
      #[9/2 1:55] Amatxu Les Corts: Arribant en 10 minuts
      #[9/2 1:56] Amatxu Les Corts: No enforrelleu
      f<-f[complete.cases(f),]    #Açò ha demostrat que no funciona en alguns casos. En Mariola no m'ha funcionat, així que seria mes interessant mirar quins usuaris tenen una proporció menor i els que tinguen un percentatge menor al 1 per cent, pafuera.
      #DE totes maneres, deixar-ho fora 'es interessant per si passara alguna cosa
      
      #Dataframe amb el recompte d'intervencions per usuari
      d<-as.data.frame(table(f$usuari))
      
      #Quins son els usuaris que no intervenen mes d'un 0.0075
      usuaris_no<-as.character(d[which(d$Freq < quantile(1:nrow(f),0.0015)),]$Var1)
      
      f<- f[!f$usuari %in% usuaris_no,]
      
      #Eliminem el missatge "Ara els missatges d'aquest grup estan protegits amb encriptació d'extrem a extrem." que reconeix el nom del grup com a usuari
      #Se podria mirar d'optimitzar ja que apareix pel principi    ######################################
      if (idioma_movil=="catalan"){
        f<- f[!str_detect(f$comm, "Ara els missatges d'aquest grup"),]
        
      }else if (idioma_movil=="english"){
        f<- f[!str_detect(f$comm, "Messages to this chat and calls are"),]
      }
      
      
      f$usuari<-as.character(f$usuari)
      f$usuari<-as.factor(f$usuari)
    }
    
    #canviar
    if (idioma_movil=="x" | any(!complete.cases(f)) | nrow(f) < nrow(estructura_false)| length(unique(f$usuari))>256){
      
      f<-"problema_xat"
      
      
    }else{
      
      cat("SUCCESS!!!!")
      
      xat<-f
      #-------------------------------------- FEM ELS Analytics
    
      #canvi en el progr'es
      progress$inc(amount = 1/5, detail = "Preparant Analytics!")
      
      #creem el directori on anira tot
      dir.create(tmp <- tempfile())
      
      #crea una ruta del zip
      zipfile <- tempfile(fileext = ".zip")
      
      #Idioma de l'Analytics
      idioma= input$idioma_analytics
      if (idioma=="val"){

        out <- rmarkdown::render('Analytics_PRO_val.Rmd',
                      output_dir = tmp )
        
        file.rename(out, file.path(tmp,"Analytics PRO.html"))
        
        
        zip::zip(zipfile, "Analytics PRO.html", root = tmp)
        #zip_append(zipfile, file.path( "Tangible x"), root = tmp)
        
      }else if(idioma=="cast"){
        
        out <- rmarkdown::render('Analytics_PRO_cast.Rmd',
                      output_dir = tmp )
        
        file.rename(out, file.path(tmp,"Analytics PRO.html"))
        
        
        zip::zip(zipfile, "Analytics PRO.html", root = tmp)
        
      }else{}
      
      
      #------------------------ CREACIO DE LES IMATGES TANGIBLE
      
      progress$inc(amount = 1/5, detail = "Creant les imatges que has demanat!")
      
      #deixem sols 6 columnes del xat.
      xat<-xat[,1:6]
      
      tria<-get_tria(input)
      #creem les imatges depenent de les demandes que fa
      for (x in str_split(tria, "-")[[1]][str_split(tria, "-")[[1]]!=""]){
        cat(x, "-\n")
        
        fer_imatges(xat, x, tmp,zipfile)
      }
      
      
      
      
      
      progress$inc(amount = 1/5, detail = "Enviant-te la comanda al correu!")
      
      # ------------------- EMAIL
      
      compose_email(
        header = md(c("<a href='https://tangibleanalytics.eu'>", img, "</a>")),
        body =
          
          md(c("<br><font size='7'><span style='color: #831923; font-weight:bold;'>Hola!</span> </font><br><br>",
             "<font size='4'>Ho estaves esperant, eh ;)<br><br>",
             "Doncs ja ho tens ací: tot allò que has demanat ja és <span style='color: #831923; font-weight:bold;'>Tangible!</span><br><br>",
             "Ho pots trobar en l'adjunt d'aquest correu dins d'un zip. Tan sols has de descomprimir-lo i començar a <span style='color: #831923; font-weight:bold;'>regalar i compartir!</span><br><br>",
             "Pots descomprimir-lo directament al teu dispositiu o a través d'aquesta <a href='https://extract.me/'>pàgina web</a>.<br><br>",
             "Atentament, l'equip de <span style='color: #831923; font-weight:bold;'>Tangible Analytics</span> <br><i>Regala converses, regala relacions</i></font><br><br>")),
        
        footer =
          blocks(
            block_text("Segueix-nos a:", align = "center"),
            block_text(""),
            block_text(""),
            block_social_links(
              social_link(
                service = "instagram",
                link = "https://www.instagram.com/tangibleanalytics/",
                variant = "color"
                ),
              social_link(
                service = "facebook",
                link = "https://www.facebook.com/tangibleanalytics",
                variant = "color"
                )
              )
          )
        
        ) %>%
        
        add_attachment(file=zipfile,
                     filename = "Experiència Tangible.zip") %>%
        
        smtp_send(
          from = c("Tangible Analytics" = "info@tangibleanalytics.eu"),
          to = input$email,
          subject = "Enhorabona! La teua conversa ja és Tangible!",
          credentials = creds_key(id = "honesting")
          
          )
      
    
      
    }
    
    return(f)
  
}




  
  
#EL tema de la ruta falta per vore.
fer_imatges<- function(xat, x, tmp, zip_addr){
  
  
  #Per a que esta funcio funcione, necessitem quina tipus d'imatge tria i el color de la paleta. ho obtenim amb el que se li passa a la funcio
  color_triat=  as.numeric( str_split(x, ":")[[1]][2])
  tipus=str_split(x, ":")[[1]][1]
  
  
  if (tipus=="T"){ #IMATGE DE TOTA LA CONVERSA
    
    print("Tota la conversa feta")
    
    #Creem la ruta particular i la carpeta per a cada opcio
    ruta_particular=paste0(tmp, "/Tangible/")
    dir.create(ruta_particular)
    
    
    Data<-xat %>%
      unnest_tokens(input = comm,
                    output = words) %>%
      filter(!words %in% stop_words) %>%
      count( words, sort = TRUE) 
    
    
    #Comprovar el tema dels emojis
    Data<-Data[!grepl("^[0-9]"  ,Data$words),]
    Data<-Data[!grepl(x = Data$words, pattern = "[^\x01-\x7Féèíàáòóúñçüïëûæâôβß€ÇÀÁÈÙÌÒÉÍÚÓÑ@]"),]
    Data<-Data[!grepl(x = Data$words, pattern = "@"),]
    
    #Limitem les paraules a 200?   
    #Tambe te un sistema per a adaptar la freq
    if (nrow(Data)>200){
      Data<-Data[1:200,]
      Data$freq<- FREQ
    }else if(nrow(Data)>0){
      Data$freq<-FREQ[1:nrow(Data)]
    }
    
    #llevem el conteig fet per la funcio i posem les nostres
    Data<- select(Data, -n)
    
    
    #Arreglem alguna posicio de les paraules
    Data$words<-arreglar_paraules(Data$words)
    
    set.seed(13)
    my_graph<-wordcloud2(data=Data, color =paletes_color[,color_triat][1:nrow(Data)],gridSize= 2)
    
    # save it in html
    saveWidget(my_graph, paste0(tmp,"/x.html"), selfcontained = F )
    
    # save it in pdf on png
    webshot(paste0(tmp,"/x.html"),paste(ruta_particular,"All.png", sep =""), delay =10, vwidth =1350, vheight=1080)
    
    #ho guardem en el zip
    zip_append(zip_addr, file.path( "Tangible"), root = tmp)
    
    
    #######################################################################   
  } else if (tipus=="H"){ #24Hores de la conversa
    
    print("24 hores")
    
    #Creem la ruta particular i la carpeta per a cada opcio
    ruta_particular=paste0(tmp, "/Tangible 24h/")
    dir.create(ruta_particular)
    
    
    i=1
    for(x in unique(xat$hora2)){
      
      
      Data<-xat %>%
        filter(hora2==x) %>%
        unnest_tokens(input = comm,
                      output = words) %>%
        filter(!words %in% stop_words) %>%
        count( words, sort = TRUE)
      
      
      #Comprovar el tema dels emojis
      Data<-Data[!grepl("^[0-9]"  ,Data$words),]
      Data<-Data[!grepl(x = Data$words, pattern = "[^\x01-\x7Féèíàáòóúñçüïëûæâôβß€ÇÀÁÈÙÌÒÉÍÚÓÑ@]"),]
      Data<-Data[!grepl(x = Data$words, pattern = "@"),]
      
      #Limitem les paraules a 200?   
      #Tambe te un sistema per a adaptar la freq
      if (nrow(Data)>200){
        Data<-Data[1:200,]
        Data$freq<- FREQ
      }else if(nrow(Data)>0){
        Data$freq<-FREQ[1:nrow(Data)]
      }
      
      #llevem el conteig fet per la funcio i posem les nostres
      Data<- select(Data, -n)
      
      #Arreglem alguna posicio de les paraules
      Data$words<-arreglar_paraules(Data$words)
      
      
      
      
      
      #Execucio del wordcloud i colors
      
      if (color_triat==5){ #SI tria els colors del dia i la nit
        
        if (nrow(Data)==0){
          
          #Agafem els colors depenent de l'hora
          color=colors_hores[,x+1][0]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
        }else if(nrow(Data)>199){
          
          #Agafem els colors depenent de l'hora
          color=colors_hores[,x+1]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
          
        }else{
          
          #Agafem els colors depenent de l'hora
          color=colors_hores[,x+1][1:nrow(Data)]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
          
        }
        
      } else{ #ALTRES COLORS
        
        if (nrow(Data)==0){
          
          #Agafem els colors depenent de l'hora
          color=paletes_color[,color_triat][0]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
        }else if(nrow(Data)>199){
          
          #Agafem els colors depenent de l'hora
          color=paletes_color[,color_triat]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
          
        }else{
          
          #Agafem els colors depenent de l'hora
          color=paletes_color[,color_triat][1:nrow(Data)]
          
          #wordcloud
          my_graph<-wordcloud2(data=Data, color = color,gridSize= 2)
          
          
        }
        
        
        
      }
      
      
      #Loop del color
      i= i+ 1
      
      #convertim x a character
      x<-as.character(x)
      
      
      # save it in html
      saveWidget(my_graph, paste0(tmp,"/x.html"), selfcontained = F )
    
      # save it in pdf on png
      webshot(paste0(tmp,"/x.html"), paste(ruta_particular, x, ".png", sep =""), delay =10, vwidth =1350, vheight=1080)
      
      
      
    }
    
    
    #ho guardem en el zip
    zip_append(zip_addr, file.path( "Tangible 24H"), root = tmp)
    
    ##################################################################    
  } else if (tipus == "A"){ #PER ANY
    
    
    print("Per any")
    
    #Creem la ruta particular i la carpeta per a cada opcio
    ruta_particular=paste0(tmp, "/Tangible Any/")
    dir.create(ruta_particular)
    
    
    #For per a cada any
    xat$any<- as.factor(format(xat$data, "%Y"))
    for(x in unique(xat$any)){
      
      Data<-xat %>%
        filter(any==x) %>%
        unnest_tokens(input = comm,
                      output = words) %>%
        filter(!words %in% stop_words) %>%
        count( words, sort = TRUE)
      
      
      #Comprovar el tema dels emojis
      Data<-Data[!grepl(x = Data$words, pattern = "[^\x01-\x7Féèíàáòóúñçüïëûæâôβß€ÇÀÁÈÙÌÒÉÍÚÓÑ@]"),]
      Data<-Data[!grepl(x = Data$words, pattern = "@"),]
      Data<-Data[!grepl("^[0-9]"  ,Data$words),]
      
      #Limitem les paraules a 200 i adaptem FREQ
      if (nrow(Data)>200){
        Data<-Data[1:200,]
        Data$freq<- FREQ
      }else if(nrow(Data)>0){
        Data$freq<-FREQ[1:nrow(Data)]
      }
      
      #llevem el conteig fet per la funcio i posem les nostres
      Data<- select(Data, -n)
      
      #Arreglem alguna posicio de les paraules
      Data$words<-arreglar_paraules(Data$words)
      
      set.seed(13)
      my_graph<-wordcloud2(data=Data, color =paletes_color[,color_triat][1:nrow(Data)],gridSize= 2)
      
      #convertim x a character
      x<-as.character(x)
      
      # save it in html
      saveWidget(my_graph, paste0(tmp,"/x.html"), selfcontained = F )
    
      # save it in pdf on png
      webshot(paste0(tmp,"/x.html"),paste(ruta_particular, x, ".png", sep =""), delay =10, vwidth =1350, vheight=1080)
      
      
      
    }
    
    #ho guardem en el zip
    zip_append(zip_addr, file.path( "Tangible Year"), root = tmp)
    
    
    ###############################################################    
    
  }else if (tipus == "P"){   # PER PERSONA
    
    print("per persona")
    print(unique(xat$usuari))
    
    
    #Creem la ruta particular i la carpeta per a cada opcio
    ruta_particular=paste0(tmp, "/Tangible Persona/")
    dir.create(ruta_particular)
    
    
    for(x in unique(xat$usuari)){
      
      x<-as.character(x)
      
      Data<-xat %>%
        filter(usuari==x) %>%
        unnest_tokens(input = comm,
                      output = words) %>%
        filter(!words %in% stop_words) %>%
        count( words, sort = TRUE)
      
      
      #Comprovar el tema dels emojis
      Data<-Data[!grepl(x = Data$words, pattern = "[^\x01-\x7Féèíàáòóúñçüïëûæâôβß€ÇÀÁÈÙÌÒÉÍÚÓÑ@]"),]
      Data<-Data[!grepl(x = Data$words, pattern = "@"),]
      #sha de fer un processament de numeros
      Data<-Data[!grepl("^[0-9]"  ,Data$words),]
      
      #Limitem les paraules a 200 i adaptem FREQ
      if (nrow(Data)>200){
        Data<-Data[1:200,]
        Data$freq<- FREQ
      }else if(nrow(Data)>0){
        Data$freq<-FREQ[1:nrow(Data)]
      }
      
      #llevem el conteig fet per la funcio i posem les nostres
      Data<- select(Data, -n)
      
      #Arreglem alguna posicio de les paraules
      Data$words<-arreglar_paraules(Data$words)
      
      
      my_graph<-wordcloud2(data=Data, color = paletes_color[,color_triat][1:nrow(Data)] ,gridSize= 2)
      
      #Adaptem els noms que tenen accent i coses rares
      x<-netejar_nom(x)
      
      # save it in html
      saveWidget(my_graph, paste0(tmp,"/x.html"), selfcontained = F )
    
      # save it in pdf on png
      webshot(paste0(tmp,"/x.html"),paste(ruta_particular, x, ".png", sep =""), delay =10, vwidth =1350, vheight=1080)
      
      
      
    }
    
    #ho guardem en el zip
    zip_append(zip_addr, file.path( "Tangible Persona"), root = tmp)
    
    
    # ------------------------ EMOJIS
    
    
  }else if (tipus == "E"){
    
    print("Emojis")
  
  
    #Creem la ruta particular i la carpeta per a cada opcio
    ruta_particular=paste0(tmp, "/Tangible Emojis/")
    dir.create(ruta_particular)
  
  
    #Preprocessament
    #emojis dels commentaris
    x<-data.frame(rwhatsapp::lookup_emoji(xat$comm))
  
  
    #Per a treure el dataset amb el total d'emojis 
    xat_emoji<-cbind(xat, x)%>%
      unnest(emoji) %>%
      group_by(emoji)%>%
      summarise(total=n())
  
    #Aci li posem les correspondencies en la info dels emojis
    xat_emoji <- inner_join(xat_emoji, emojis,by="emoji") %>% arrange(desc(total))
  
  
    #Per a les coordenades, mirem si les hem de fer o gastem les predeterminades
    if (nrow(xat_emoji)>=49){
    
      load("./needs/coordenades.R")
    
      #el limitem a 49 entrades
      xat_emoji<-xat_emoji[1:49,]
    
    } else{
      coordenades<-fer_coordenades(nrow(xat_emoji))
    
    }
    
    #fem cada una de les imatges
    fer_imatges_emojis(xat_emoji, coordenades = coordenades, ruta_particular =ruta_particular, tipus = 1)
    fer_imatges_emojis(xat_emoji, coordenades = coordenades, ruta_particular =ruta_particular, tipus = 2)
    fer_imatges_emojis(xat_emoji, coordenades = coordenades, ruta_particular =ruta_particular, tipus = 3)
    fer_imatges_emojis(xat_emoji, coordenades = coordenades, ruta_particular =ruta_particular, tipus = 4)

    #ho guardem en el zip
    zip_append(zip_addr, file.path( "Tangible Emojis"), root = tmp)
  
    }else{
  
      print("OOOOPS PROBLEMA AMB LES IMATGES")
    }
  
  
  
  
  }
  
  
  
  fer_imatges_emojis<-function(xat_emoji, tipus, coordenades , ruta_particular){
  # Se fan imatges amb els emojis
  #Tipus d'imatges: 1 mobil sense fons, 2 mobil amb fons, 3 cercle sense fons, 4 cercle amb fons
  
  
  #definim les variables necessaries per a cada tipus
  if (tipus==1){
    
    center=c(563.5, 1004)
    
    comp<- image_blank(width=1127, height=2008 ,color="#ffffff")
    comp<-image_resize(comp, geometry_size_pixels(width=1127, height=2008))
    comp<- image_convert(comp, colorspace = "sRGB")
    
    #tamanys de les imatges
    geom<-c("185x185", "185x185", rep("160x160", 8), rep("155x155", 16), rep("145x145", 23))
    
    #servix per a corregir el centre de la imatge
    ajust<-c(185/2,185/2, rep(160/2, 8), rep(155/2, 16), rep(145/2, 23))
    
    #coordenades
    x=coordenades$oval_x
    y=coordenades$oval_y
    
    #ruta
    ruta="oval_no_background.png"
    
    
  }else if(tipus==2){
    
    center=c(563.5, 1004)
    
    comp<-image_read("./needs/emoji_back3.png")
    
    #tamanys de les imatges
    geom<-c("185x185", "185x185", rep("160x160", 8), rep("155x155", 16), rep("145x145", 23))
    
    #servix per a corregir el centre de la imatge
    ajust<-c(185/2,185/2, rep(160/2, 8), rep(155/2, 16), rep(145/2, 23))
    
    #coordenades
    x=coordenades$oval_x
    y=coordenades$oval_y
    
    #ruta
    ruta="oval_background.png"
    
    
  }else if(tipus==3){
    
    
    center=c(600, 600)
    
    
    comp<- image_blank(width=1200, height=1200 ,color="#ffffff")
    comp<-image_resize(comp, geometry_size_pixels(width=1200, height=1200))
    comp<- image_convert(comp, colorspace = "sRGB")
    
    #tamanys de les imatges
    geom<-c("160x160", rep("144x144", 8), rep("112x112", 15), rep("96x96", 25))
    
    #servix per a corregir el centre de la imatge
    ajust<-c(160/2, rep(144/2, 8), rep(112/2, 15), rep(96/2, 25))
    
    #coordenades
    x=coordenades$cercle_x
    y=coordenades$cercle_y
    
    #ruta
    ruta="circle_no_background.png"
    
  }else if(tipus==4){
    
    center=c(600, 600)
    
    comp<-image_read("./needs/emoji_back4.png")
    comp<- image_convert(comp, colorspace = "sRGB")
    
    
    #tamanys de les imatges
    geom<-c("160x160", rep("144x144", 8), rep("112x112", 15), rep("96x96", 25))
    
    #servix per a corregir el centre de la imatge
    ajust<-c(160/2, rep(144/2, 8), rep(112/2, 15), rep(96/2, 25))
    
    
    #coordenades
    x=coordenades$cercle_x
    y=coordenades$cercle_y
    
    #ruta
    ruta="circle_background.png"
    
  }
  
  
  i=1
  while (i <= nrow(xat_emoji)){
    comp<-image_composite(comp,image_scale(image_read(paste0('./needs/emojis3/', xat_emoji$urls[i])), geometry = geom[i] ) , offset = paste0("+", center[1]+ x[i] - ajust[i],"+",center[2]+y[i]-ajust[i]) )
    
    i=i+1
  }
  
  image_write(comp, paste0(ruta_particular, ruta),'png')
  
  remove(comp)
  
  gc()
  
  Sys.sleep(5)
  
}


fer_coordenades<- function(num){
  #se creen les coordenades dels emojis si el nombre d'emojis es menor a 49
  
  #cercle
  #per al tercer cercle
  n=num-24
  r=520
  
  x3=c()
  y3=c()
  
  for (theta in 1:(n) *((2*pi)/n)){
    
    x3=c(x3,  r* sin(theta))
    y3=c(y3, r* cos(theta))
    
  }
  
  coordenades<-data.frame(cercle_x=c(0 , 1.484924e+02 , 2.100000e+02 , 1.484924e+02 , 2.571673e-14 ,-1.484924e+02, -2.100000e+02, -1.484924e+02, -5.143347e-14,  1.545599e+02, 2.823950e+02 , 3.614015e+02 , 3.779183e+02,  3.290897e+02 , 2.233584e+02 , 7.900644e+01 ,-7.900644e+01, -2.233584e+02, -3.290897e+02, -3.779183e+02,-3.614015e+02, -2.823950e+02, -1.545599e+02, -9.307008e-14, x3 ),
                          cercle_y=c(0, 1.484924e+02,  1.285837e-14, -1.484924e+02, -2.100000e+02 ,-1.484924e+02 ,-3.857510e-14,  1.484924e+02 , 2.100000e+02,  3.471473e+02,2.542696e+02,  1.174265e+02, -3.972082e+01, -1.900000e+02, -3.074265e+02, -3.716961e+02, -3.716961e+02, -3.074265e+02, -1.900000e+02, -3.972082e+01,  1.174265e+02,  2.542696e+02,  3.471473e+02,  3.800000e+02, y3))
  
  
  #oval
  
  #per al tercer cercle
  n=num-24
  a=900
  b=460
  
  x3=c()
  y3=c()
  
  for (theta in 1:(n) *((2*pi)/n)){
    
    x3=c(x3,  a* cos(theta))
    y3=c(y3, b* sin(theta))
    
  }
  
  coordenades$oval_x<-c(0,0,137.5262 , 165.0000,  137.5262, -137.5262, -165.0000, -137.5262 ,   0.0000 ,   0.0000,  124.3721 , 229.8097 , 300.2608 , 325.0000 , 300.2608,  229.8097 , 124.3721, -124.3721 ,-229.8097, -300.2608,-325.0000, -300.2608, -229.8097, -124.3721, y3)
  coordenades$oval_y<-c(-9.500000e+01,  9.500000e+01,  2.210125e+02 , 1.071796e-05, -2.210125e+02, -2.210125e+02,  7.846124e-06 , 2.210125e+02, -3.450000e+02 , 3.450000e+02, 6.929096e+02 , 5.303301e+02 , 2.870126e+02 , 2.009617e-05 ,-2.870126e+02 ,-5.303301e+02 ,-6.929097e+02, -6.929097e+02, -5.303301e+02, -2.870126e+02, 1.471148e-05 , 2.870126e+02 , 5.303301e+02,  6.929096e+02, x3)
  
  return(coordenades)
}





get_tria<- function(input){
  
  #TOT
  if (input$EN_UNA){
    
    tria=paste0("T:",input$T)
    
  }else{
    
    tria=""
  }
  
  #HORES
  if (input$HORES){
    
    tria=paste0(tria,"-", "H:",input$H)
    
  }
  
   #HORES
  if (input$ANYS){
    
    tria=paste0(tria,"-", "A:",input$A)
    
  }
  
   #PERSONES
  if (input$PERSO){
    
    tria=paste0(tria,"-", "P:",input$P)
    
  }
  
   #EMOJIS
  if (input$EMOJIS){
    
    tria=paste0(tria,"-", "E:",input$E)
    
  }

  return(tria)
  
}


arreglar_paraules<-function(paraules){
  i=1
  new_v<-c()
  later<-c()
  
  while(i<=round(length(paraules)*0.55)){
    if (grepl("^(xd|qe|ya|si|no|tens|ps|dps|vl|nah|mica|lol|dsp|passe|jaj|jej|heh|jij|hah|tb|esq|xq|pos|vrd|ns|pq|dnd|sii|pork|cmo|porq|tngo|oki|ay|perf|hora|vd|aunk|puf|vdd|pos|perq|res|hola|ara|sha)",
              paraules[i])){
      later<-c(later, paraules[i])
      
    }else{
      new_v<-c(new_v, paraules[i])
    }
    
    i=i+1
  }
  
  
  new_v<-c(new_v, later, paraules[i:length(paraules)])
  return(new_v)
  
}
```

```{r}
## Some files to zip up. We will run all this in the R sesion's
## temporary directory, to avoid messing up the user's workspace.
dir.create(tmp <- tempfile())
dir.create(file.path(tmp, "mydir"))
cat("first file", file = file.path(tmp, "mydir", "file1"))
cat("second file", file = file.path(tmp, "mydir", "file2"))

zipfile <- tempfile(fileext = ".zip")
zip::zip(zipfile, "mydir", root = tmp)

## List contents
zip_list(zipfile)

## Add another file
cat("third file", file = file.path(tmp, "mydir", "file3"))
zip_append(zipfile, file.path("mydir", "file3"), root = tmp)
zip_list(zipfile)
```


```{r}
my_css<- c(" @import url('https://fonts.googleapis.com/css?family=Cabin:400,400i,700&display=swap');



   article {
    width: 100%;
    opacity: 0.97;
    padding: 20px;
    margin: 0px auto 0px;
    background-color: #fff;
    box-shadow: #c0c0c0 5px 0px 35px -8px;
}


#text{
  color:#831923;
}


.site-content-inner,
.front-page-section-inner {
	width: 100%;
}

.header {
      text-align: center;
    background: white;
    color: #831923;
    font-size: 40px;
    font-weight: bold;
    text-shadow: -1.5px 1.5px #e77e89;
}

subheader {
    font-style: italic;
    font-size: 30px;
}

.temps{
  text-align:center;
  font-size: 26px;

}

.persones{
  text-align:center;
  font-size: 25px;

}


* {
    box-sizing: border-box;
}
article {
    display: block;
}


#shiny-notification-panel{

               position: fixed;
               top: 20%;
               left: 25%;
               width: 50%;
               height: 63px;
               padding: 5px 0px 5px 0px;
               text-align: center;
               font-weight: bold;
               font-size: 100%;
               color: #000000;
               background-color: #CCFF66;
               z-index: 105;
}

#TOC:hover {
  opacity: 1;
}




.nav-pills>li.active>a, .nav-pills>li.active>a:focus, .nav-pills>li.active>a:hover {
    color: #fff;
    background-color: #831923;
}


.tocify {

  width: 100% !important;
  border: none;
}

   /* TOC links */

.list-group-item {
    color: #7b8a8b;
    font-size: 16px;
    opacity: 0.96;
}

.list-group-item.active {
    color: #2c3e50;
    background-color: white;
    border: none;
}

.list-group-item:hover, 
.list-group-item.active:hover {
    color: #131b23;
    background-color: white;
}

a {
    color: #831923;
    text-decoration: auto;
}

a:hover {
 color: #780A15; /* darker color when hovering */
}



.navbar-default {
    background-color: #141c25f2;
}

.navbar-default .navbar-nav>.open>a, 
.navbar-default .navbar-nav>.active>a, 
a.dropdown-toggle:hover {
  background-color: #141c25 !important;
}

/* Dropdown menu color */
.navbar-default .dropdown-menu {
  background-color: #141c25;
}

/* Dropdown menu hover color */
  .navbar-default .dropdown-menu>li>a:hover {
    background-color: #202831f2;
  }

/* Navbar Links when hovered*/
.navbar-default .dropdown-menu>.active>a
.navbar-default .navbar-nav>.active>a:hover, 
.navbar-default .navbar-nav:hover, 
.navbar-default .navbar-nav>li>a:hover, 
a.navbar-brand:hover {
  color: #ffffffab !important;
  background-color: #141c25;
}

ftitol{
  font-size:25px;
  font-weight:bold;
  text-align: center;
  
}

.funfact{
text-align: center; 
font-size:25px;  
font-weight:bold; 
color: gold;

}

/* funfact */

.card {
  background: #fff;
  border-radius: 2px;
  display: block;
  height: auto;
  margin: 1rem;
  position: relative;
  width: 85%;
  margin-left: auto;
  margin-right: auto;
  padding-left: 4%;
  padding-block: 2%;
  padding-right: 4%;
  text-align: center;
}

.card-1{

  box-shadow: rgba(131, 25, 35, 0.4) -5px 5px, rgba(131, 25, 35, 0.3) -10px 10px, rgba(131, 25, 35, 0.2) -15px 15px, rgba(131, 25, 35, 0.1) -20px 20px, rgba(131, 25, 35, 0.05) -25px 25px;


}

.card-2{

box-shadow: rgba(240, 46, 170, 0.4) 0px 5px, rgba(240, 46, 170, 0.3) 0px 10px, rgba(240, 46, 170, 0.2) 0px 15px, rgba(240, 46, 170, 0.1) 0px 20px, rgba(240, 46, 170, 0.05) 0px 25px;

}

.card-3{
box-shadow: rgba(240, 46, 170, 0.4) 5px 5px, rgba(240, 46, 170, 0.3) 10px 10px, rgba(240, 46, 170, 0.2) 15px 15px, rgba(240, 46, 170, 0.1) 20px 20px, rgba(240, 46, 170, 0.05) 25px 25px;

}

.card-4{
box-shadow: rgba(0, 0, 0, 0.07) 0px 1px 2px, rgba(0, 0, 0, 0.07) 0px 2px 4px, rgba(0, 0, 0, 0.07) 0px 4px 8px, rgba(0, 0, 0, 0.07) 0px 8px 16px, rgba(0, 0, 0, 0.07) 0px 16px 32px, rgba(0, 0, 0, 0.07) 0px 32px 64px;

}

body{
  font-family:  'Cabin','Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
  font-size: 12pt;
  background-color:#ffffff;

 # background-image: url('https://tangibleanalytics.eu/wp-content/uploads/2021/01/back6.gif');
  background-repeat: repeat;
  background-size: 450px 450px;
}


#nav_logo {
  width: 100%;
  margin-top: 20px;
}


code, kbd, pre, samp {
    font-family:'Cabin','Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
    text-align: center;
    
}

pre {
    display: flow-root;
    padding: 9.5px;
    margin: 0 0 10px;
    font-size: 16px;
    line-height: 1.42857143;
    border: 0px
    
}

p.caption {
  font-size: 0.9em;
  font-style: italic;
  color: grey;
  margin-right: 10%;
  margin-left: 10%;  
  text-align: center;
}

#Button de les imatges
.btn-group-vertical>.btn, .btn-group>.btn  {
  padding:0px;
}





  /* Space Between TOC and 
  Righthand side content on large screens */

 @media (min-width: 992px) {
    .col-md-9 {
      width: 75%;
      padding-left: 5em !important;
    }
 }
 
 
#TOC::before {
  content: '';
  display: block;
  height: 111px;
  margin: 10px 0px 0px 0px;
  #background-image: url('https://tangibleanalytics.eu/wp-content/uploads/2021/01/logo.png');
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
  opacity: 0.97;
  background-color: #ffffff;

}


@media only screen and (max-width: 600px) {
   article {
    width: 115%;
    opacity: 0.96;
    padding: 8px;
    margin: 0px -5.8% -0px;
    background-color: #fff;
    box-shadow:#fff 0px 0px 0px 0px;
    
}


.funfact{
text-align: center; 
font-size:20px;  
font-weight:bold; 
color: gold;

}

body{
  background-size: 150px 150px;
  font-size: 10pt;
}

p.caption {
  font-size: 7.5pt;
  font-style: italic;
  color: grey;
  margin-right: 10%;
  margin-left: 10%;  
  text-align: center;
}

h1 {
    font-size: 24px;
}

.card {
  background: #fff;
  border-radius: 2px;
  display: block;
  height: auto;
  margin: 1rem;
  position: relative;
  width: 95%;
  margin-left: auto;
  margin-right: auto;
  padding-left: 4%;
  padding-block: 2%;
  padding-right: 4%;
  text-align: center;
}
.temps{
  text-align:center;
  font-size: 20px;

}

.persones{
  text-align:center;
  font-size: 17px;

}

subheader {
    font-style: italic;
    font-size: 19px;
}
.header {

    font-size: 28px;

}



} ")



```


```{r}
# de les imatges per a triar el color
df <- data.frame(
  val = c("Nenúfar","Giverny", "Soleil", "Arearea")
)
df$img = c(
  sprintf("<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100px><div class='jhr'>%s</div></img>", df$val[1]),
  sprintf("<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100px><div class='jhr'>%s</div></img>", df$val[2]),
  sprintf("<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100px><div class='jhr'>%s</div></img>", df$val[3]),
  sprintf("<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100px><div class='jhr'>%s</div></img>", df$val[4])
  )


ui <- fluidPage(
  tags$head(tags$style("
                       .jhr{
                       display: inline;
                       vertical-align: middle;
                       padding-left: 10px;
                       }")),
 pickerInput(inputId = "Id0109",
             label = "pickerInput Palettes",
             choices = df$val,
             choicesOpt = list(content = df$img, 
                               dropdownAlignRight="auto"))

  )
```



```{r}


ui <- fluidPage(
   #Pujada del fitxer
           
           fileInput("upload", 
                     label = i18n$t("Pujada de la conversa:"),
                     accept="text/plain",
                    multiple = FALSE),
  verbatimTextOutput("value")
)

server <- function(input, output) {
  
  xat <- reactive({
    df <- input$file
    
    if (is.null(df))
      return(NULL)
})
  
  output$value<- renderPrint(df$type)
  
}

shinyApp(ui, server)




          
```


# Sobre la popup window

```{r}


# This function computes a new data set. It can optionally take a function,
# updateProgress, which will be called as each row of data is added.
compute_data <- function(updateProgress = NULL) {
  # Create 0-row data frame which will be used to store data
  dat <- data.frame(x = numeric(0), y = numeric(0))

  for (i in 1:10) {
    Sys.sleep(0.25)
  
    # Compute new row of data
    new_row <- data.frame(x = rnorm(1), y = rnorm(1))

    # If we were passed a progress update function, call it
    if (is.function(updateProgress)) {
      text <- paste0("x:", round(new_row$x, 2), " y:", round(new_row$y, 2))
      updateProgress(detail = text)
    }

    # Add the new row of data
    dat <- rbind(dat, new_row)
  }

  dat
}


server <- function(input, output) {
  output$table <- renderTable({
    input$goTable

    # Create a Progress object
    progress <- shiny::Progress$new()
    progress$set(message = "Computing data", value = 0)
    # Close the progress when this reactive exits (even if there's an error)
    on.exit(progress$close())
    
    # Create a callback function to update progress.
    # Each time this is called:
    # - If `value` is NULL, it will move the progress bar 1/5 of the remaining
    #   distance. If non-NULL, it will set the progress to that value.
    # - It also accepts optional detail text.
    updateProgress <- function(value = NULL, detail = NULL) {
      if (is.null(value)) {
        value <- progress$getValue()
        value <- value + (progress$getMax() - value) / 5
      }
      progress$set(value = value, detail = detail)
    }

    # Compute the new data, and pass in the updateProgress function so
    # that it can update the progress indicator.
    compute_data(updateProgress)
  })
}

ui <- shinyUI(basicPage(
  tableOutput('table'),
  actionButton('goTable', 'Go table')
))

shinyApp(ui = ui, server = server)
```



```{r}
output$downloadData <- downloadHandler(

filename = ("Experiencia Tangible.zip"),


content = function(file) 
{

k <- (input$myTable1_rows_selected)
fs <- c()
for ( i in k) 
  {
  path <- paste0(i,".docx")
  rmarkdown::render("R_markdown_script.Rmd", output_file = path , 
  params = list(j=i), envir = new.env(parent = globalenv()))

  fs <- c(fs,path)
  }
zip(zipfile = file, files = fs)

  }, 
  contentType = "application/zip" )











output$downloadData <- downloadHandler(

filename = function()
{
  paste("output", "zip", sep = ".")
},
content = function(file)
{
k = list(input$myTable1_rows_selected)
fs <- c()
for ( i in k) 
{ 
  params <- list(j=i)
  path <- paste(i,".docx")

  rmarkdown::render("R_markdown_script.Rmd", rmarkdown::word_document(),         
                    output_file = path , params = params, 
                    envir = new.env(parent = globalenv()))

  fs <- c(fs,path)
} 
zip(zipfile = file, files = fs)
if (file.exists(paste0(file, ".zip")))
  file.rename(paste0(file, ".zip"), file)
}, 
contentType = "application/zip" )
}

```


```{r}
ui <- fluidPage(
  
  #per a que funcionen les traduccions
  shiny.i18n::usei18n(i18n),
  
  #css
  tags$head(
    tags$link(rel = "stylesheet", type = "text/css", href = "./www/style.css")
  ),
  includeCSS("./www/style.css"),
  tags$head(tags$style(HTML(my_css))),
  
  
  # ---------------------------- UI
  fluidRow(
    #Espai
    column(3,
           tags$br(), 
           
           #SelectInput Idioma des del panell superior esquerre
           uiOutput("idioma_display")),
    
    column(7, offset = 1,
           
           #titol
           titlePanel("Personalitza la conversa!"),
           
           #Pujada del fitxer
           #tags$h4(i18n$t("Pujada de la conversa:")),
           fileInput(inputId = "upload", 
                     label = i18n$t("Pujada de la conversa:"),
                     accept="text/plain",
                    multiple = FALSE),
           
           
           # Idioma Analytics
           tags$h3("ANALYTICS"),
           uiOutput("idioma_analytics"),
           
           tags$br(), 
           # ------------------- INPUTS PER A PERSONALITZAR LA CONVERSA
           tags$h3("TANGIBLE"),
           tags$h4("Escull ara de quina manera vols Tangibilitzar la conversa amb imatges dels apartats següents:"),
           tags$br(),
           #-------- EN UNA
           checkboxInput("EN_UNA", label = i18n$t("La conversa EN UNA imatge")),
           conditionalPanel(
             condition = "input.EN_UNA == true",   #condicio
             radioGroupButtons(
               inputId = "T",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- 24 HORES
           checkboxInput("HORES", label = i18n$t("24 HORES de la conversa")),
           conditionalPanel(
             condition = "input.HORES == true",   #condicio
             radioGroupButtons(
               inputId = "H",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),

           #-------- ANYS
           checkboxInput("ANYS", label = i18n$t("ANYS de la conversa")),
           conditionalPanel(
             condition = "input.ANYS == true",   #condicio
             radioGroupButtons(
               inputId = "A",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- PERSONES
           checkboxInput("PERSO", label = i18n$t("PERSONES de la conversa")),
           conditionalPanel(
             condition = "input.PERSO == true",   #condicio
             radioGroupButtons(
               inputId = "P",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           #-------- EMOJIS
           checkboxInput("EMOJIS", label = i18n$t("EMOJIS de la conversa")),
           conditionalPanel(
             condition = "input.EMOJIS == true",   #condicio
             radioGroupButtons(
               inputId = "E",
               label = i18n$t("Tria el color de la imatge:"), 
               choices = c(`<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/nenufar_tria2.png' width=100%><div class='jhr'></div></img> Nenúfar` = "4", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/giverny_tria2.png' width=100%><div class='jhr'></div></img> Giverny` = "1", 
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/arearea_tria2.png' width=100%><div class='jhr'></div></img> Arearea` = "3",
                           `<img src='https://tangibleanalytics.eu/wp-content/uploads/2021/02/soleil_tria2.png' width=100%><div class='jhr'></div></img> Soleil` = "2"),
               justified = TRUE,
                 width = "88%"
               )
             ),
           
           # ---------------- EMAIL I ENVIAMENT
           tags$br(),
           
           textInput("email","Correu electrònic:"),
           
           awesomeCheckbox(
             inputId = "accept",
             label = "Vols inscriure't a la nostra Newsletter per a estar atenta al progrés del projecte i saber les últimes novetats?",
             value = TRUE,
             status = "info",
              width = "95%"
             ),
           
           tags$br(),
           
           
           div(id = "downloadBtn",    downloadButton("downloadData", "Preparar i enviar comanda!")),
           
           #actionButton("enviar", " Preparar i enviar comanda! ", class = "btn-primary btn-lg" ),
          
           
           tags$br(), tags$br(),tags$br(), tags$br(),tags$br(), tags$br()
           
           ) #fi mainPanel
    )
  )






server = function(input, output, session) {
  
  
  # -------------------------------------------------------------- IDIOMA I TRADUCCIONS
  
  #Llegim el fitxer amb les traduccions
  i18n <- Translator$new(translation_json_path = "./needs/translations.json")

    # Show modal al principi d'entrar
  showModal(modalDialog(
      title = HTML("<div style='text-align: center;'>IDIOMA / LANGUAGE</div>"),
        HTML("<div style='text-align: center;'>VAL - Escull l'idioma de la sessió<br><br>
        CAST - Escoge el idioma de la sesión<br><br>ENG - Choose the session language<br><br></div>"),
        
        radioGroupButtons(
          inputId = "idioma",
          choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
          justified = TRUE,
          checkIcon = list(
            yes = tags$i(
              class = "fa fa-check-square", 
              style = "color: rgb(0,166,90)"
),
            no = icon("square-o"))),
        footer = tagList(
          actionButton("ok", "OK")
        )
      ))
    
    # When OK button is pressed, es tanca la pantalla emergent
    observeEvent(input$ok, {

      values$idioma<-input$idioma
      #canviem l'idioma que ha seleccionat  
      update_lang(session, isolate(values$idioma))
        
      #llevem la pestanya emergent
      removeModal()
      
      #posem el seleccionador en la pg
      output$idioma_display<-renderUI(
        
      selectInput(
             inputId='idioma2',
             label=i18n$t("Canviar l'idioma"),
             choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
             selected = isolate(values$idioma),
             width = "45%")
      )
      
      output$idioma_analytics<-renderUI(
        selectInput(
             inputId='idioma_analytics',
             label=i18n$t("Tria l'idioma de l'Analytics"),
             choices = c("Valencià"="val","Castellano"="cast", "English"="eng"),
             selected = isolate(values$idioma))
      )
      
      
    })
    
    # Per si es vol canviar l'idioma una vegada desapareix el popup
    observeEvent(input$idioma2, {
      values$idioma<-input$idioma2
      
    update_lang(session, isolate(values$idioma))
  })

    #------------- Quan s'apreta el boto enviar. se desencadena tot
    
    output$downloadData <- downloadHandler(
      filename = "Experiencia Tangible.zip",
      content = function(file)
        {
        
      #Requeriments. queda millorar
      req(input$email, input$upload)
      

      #creacio de la barra de progres
      progress <- shiny::Progress$new()
      progress$set(message = "Preparant Comanda", value = 0)
    # Close the progress when this reactive exits (even if there's an error)
      on.exit(progress$close())
      
      progress$inc(amount = 1/5, detail = "Llegint i estructurant el xat!")
      
      
      
      
      #-------------------------- ACCIONS SOBRE EL FITXER
      
      #rebem el df del fitxer
      file2<-input$upload
      
      #llegim el fitxer
      zipfile<-infolectura_fitxer(file2$datapath, input, progress, file)

      cat("jasta!")
      progress$inc(amount = 1/5, detail = "Tot en ordre! Revisa el correu!")
            
      
      showModal(modalDialog(
        title = HTML("<div style='text-align: center;'>FELICITATS!</div>"),
        HTML("<div style='text-align: center;'>Acabes de convertir una relació en Tangible!<br><br>En breus moments rebràs al correu la teua comanda<br><br><br>El xat que ens acabes de proporcionar ja ha estat eliminat dels nostres servidors, així com la comanda associada!<br></div>"),
        easyClose = TRUE,
        footer = tagList(
          actionButton("ok2", "OK")
        )
      ))
      
    zipfile
              
        }, 
contentType = "application/zip" )
      


    #Eliminar el modal
    observeEvent(input$ok2, {
      #llevem la pestanya emergent
      removeModal()
    
  })
        
    
    
}




shinyApp(ui, server)

```










```{r}
infolectura_fitxer<- function(nom_xat, input, progress, file){
  
  "
  Llig el fitxer i el retorna estructurat si es correcte. Si no, retorna 'problema_xat' i es notifica
  
  
  "

    #Lectura del fitxer
    f <- read.delim(file=nom_xat, quote = "" , encoding = "UTF-8", header = F, colClasses = "character")
    
    #llevem les linies repetides
    f<-unique(f)
    
    #Distincio entre IOS i la RESTA. IOS té "[]".
    if (grepl(f[1,1],pattern= "\\[.*\\]")){       #És IOS. Arxius i audios omesos tenen un caracter especial al principi
      
      #guardem el tipus de l'estructura
      tipus<-"IOS"
      
      
      #açò se pot abreviar en la versió online
      ########################################################################################
      #Mirem quins tenen l'estructura. Servix per a /n i missatges de grup
      f<- f %>% mutate(estructura=grepl(pattern="\\[\\d*\\/.*\\]",V1))  #ESTRUCTURA: tipus "[num/algo]"
      
      #Agafem sols els que seguixen l'esquema general
      estructura_false<- f %>% filter(estructura==F)
      f<- f %>% filter(estructura==T)
      ########################################################################################
      
      
      #Idioma
      #Determinem idioma                            #Son els que no comencem per [, ja que la multimedia comensa per un caracter especial
      if(any(grepl("omitido|omitida", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"spanish"
        
      }else if(any(grepl("omès|omesa", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"catalan"
        
      }else if(any(grepl("omitted", head(f$V1[!grepl("^(\\[|\\s)", f$V1)]), ignore.case = T))){
        idioma_movil<-"english"
        
      }else {
        idioma_movil<-"x"
      }
      
      
      #Busquem si té coma entre [], si en té assumim que és ANGLÉS
      if (idioma_movil=="english"){  
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\[", into=c("res", "V1"), extra="merge") %>%
          select(-res)%>% #Servix per a llevar-nos un element que sols té IOS en audios, imatges
          separate(V1, "\\] ", into=c("temps", "resta"), extra="merge") %>%  
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge") %>%
          separate(temps, "\\,", into = c("data", "hora"), extra="merge") %>%
          select(-estructura)
        
        #Per als fs que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        #Adaptem el tipus de dada
        f$data<- as.Date(f$data, format="%d/%m/%Y")
        f$hora<-parse_time(f$hora, format= "%H:%M:%S" )
        f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
        f$usuari<-as.factor(f$usuari)
        
        
        
        
      }else if(idioma_movil=="spanish" | idioma_movil=="catalan") {#No és ANGLÉS
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\[", into=c("res", "V1"), extra="merge") %>%
          select(-res)%>%
          separate(V1, "\\] ", into=c("temps", "resta"), extra="merge") %>%  
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge") %>%
          separate(temps, "\\s", into = c("data", "hora"), extra="merge")%>%
          select(-estructura)
        
        #Per als fs que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        #Adaptem el tipus de dada
        f$data<- as.Date(f$data, format="%d/%m/%y")
        f$hora<-hms(f$hora )
        f$hora2<-as.integer(hour(f$hora))  #Ho necessita el plot del temps x hores
        f$usuari<-as.factor(f$usuari)
        
        
        
      }
    }else{ #No és IOS. RESTA 
      
      #guardem el tipus de l'estructura
      tipus<-"resta"
      
      
      #Afegim el valor estructura, per si seguix l'estructura que voliem:  num/num/num algo num:num algo -espai algo:
      f<- f %>% mutate(estructura=grepl(pattern="^\\d*\\/\\d*\\/\\d*.*\\d*\\:\\d*.*\\-\\s.*\\:",V1)) 
      
      #Agafem sols els que seguixen l'esquema general i guardem els que no
      estructura_false<- f %>% filter(estructura==F)
      f<- f %>% filter(estructura==T)
      
      
      #ANgles i Catala tenen una coma entre data i hora!!!!!!
      if (grepl("^\\d*\\/\\d*\\/\\d*\\,\\s*\\d*\\:\\d*.*\\-\\s.*\\:", f$V1[1])){ #el primer Té coma. És català o anglés
        
        #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
        f<-f%>% separate(V1, "\\,", into=c("data", "resta"), extra="merge") %>%  
          separate(resta, "\\- ", into = c("hora", "resta"), extra="merge") %>%
          separate(resta, "\\:", into = c("usuari", "comm"), extra="merge")
        
        
        #Per als xats que seguixen parcialment l'estructura. Llevar-los
        f<-f %>% filter(comm != "NA")
        
        
        #Determinem idioma_movil
        if(any(grepl("\\<Fitxers multimèdia omesos\\>", f$comm))){
          idioma_movil<-"catalan"
        }else if(any(grepl("\\<Media omitted\\>", f$comm))){
          idioma_movil<-"english"
          
        }else{
          idioma_movil<-"x"
        }
        
        
        #Adaptament al tipus de dada per idioma_movil
        if (idioma_movil=="catalan"){
          
          if(!grepl(pattern = "[ap]\\..m\\.", f[1,2] )){  #ANDROID
            
            #Adaptem el tipus de dada
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora<-hm(f$hora)
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }else{  #HUAWEI
            
            #substituim el p.m i tal
            f$hora<-gsub("p\\..m\\.","PM",f$hora)
            f$hora<-gsub("a\\..m\\.","AM",f$hora)
            
            
            #Adaptem el tipus de dada
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }
          
        }else if(idioma_movil=="english"){#és anglés
          
          #Data
          if (length(f[1, 1])==10){ #Si el valor de l'any té 4 digits. Seguix estructura %d/%m/%Y
            f$data<- as.Date(f$data, format="%d/%m/%Y")
            
          }else{ 
            f$data<- as.Date(f$data, format="%d/%m/%y")
          }
          
          #Hora
          if(grepl("M",f[1,2])){ #Si té AM o PM
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
          }else{
            f$hora<-hm(f$hora)
            
          }
          
          f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
          f$usuari<-as.factor(f$usuari)
          
        }
      }else{  #Es castella
        
        #Determinem idioma_movil
        if(any(grepl("\\<Multimedia omitido\\>", f$V1))){
          
          idioma_movil<-"spanish"
          
          
          #Separem el string que teniem en DATA, HORA, USUARI i COMMENT
          f<-f%>% separate(V1, "\\s", into=c("data", "resta"), extra="merge") %>%  
            separate(resta, "\\- ", into = c("hora", "resta"), extra="merge") %>% #l'espai!!!
            separate(resta, "\\:", into = c("usuari", "comm"), extra="merge")
          
          #Per als fs que seguixen parcialment l'estructura. Llevar-los
          f<-f %>% filter(comm != "NA")
          
          
          if(!grepl(pattern = "[ap]\\..m\\.", f[1,2] )){  #ANDROID
            
            #Adaptem el tipus de dada
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora<-hm(f$hora)
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }else{ #HUAWEI
            
            #substituim el p.m i tal
            f$hora<-gsub("p\\..m\\.","PM",f$hora)
            f$hora<-gsub("a\\..m\\.","AM",f$hora)
            
            
            #Adaptem el tipus de dada
            f$hora<-parse_time(f$hora, format= "%H:%M %p" )
            f$data<- as.Date(f$data, format="%d/%m/%y")
            f$hora2<-as.integer(hour(f$hora))  #Ho necessitael plot del temps x hores
            f$usuari<-as.factor(f$usuari)
            
          }
          
        }else{
          idioma_movil<-"x"
        }
        
        
      }
    }
    
    
    if (tipus=="IOS"){
      # En els IOS, quan reenvies missatges, es copien igual amb la mateixa estructura pero no tenen els SEGONS I ANYS, i ixen NA. emprem complete cases per a canviar-ho.
      #[9/2/19 1:58:05] Etarra: [9/2 1:55] Olatz: En casa
      #[9/2 1:55] Amatxu Les Corts: Arribant en 10 minuts
      #[9/2 1:56] Amatxu Les Corts: No enforrelleu
      f<-f[complete.cases(f),]    #Açò ha demostrat que no funciona en alguns casos. En Mariola no m'ha funcionat, així que seria mes interessant mirar quins usuaris tenen una proporció menor i els que tinguen un percentatge menor al 1 per cent, pafuera.
      #DE totes maneres, deixar-ho fora 'es interessant per si passara alguna cosa
      
      #Dataframe amb el recompte d'intervencions per usuari
      d<-as.data.frame(table(f$usuari))
      
      #Quins son els usuaris que no intervenen mes d'un 0.0075
      usuaris_no<-as.character(d[which(d$Freq < quantile(1:nrow(f),0.0015)),]$Var1)
      
      f<- f[!f$usuari %in% usuaris_no,]
      
      #Eliminem el missatge "Ara els missatges d'aquest grup estan protegits amb encriptació d'extrem a extrem." que reconeix el nom del grup com a usuari
      #Se podria mirar d'optimitzar ja que apareix pel principi    ######################################
      if (idioma_movil=="catalan"){
        f<- f[!str_detect(f$comm, "Ara els missatges d'aquest grup"),]
        
      }else if (idioma_movil=="english"){
        f<- f[!str_detect(f$comm, "Messages to this chat and calls are"),]
      }
      
      
      f$usuari<-as.character(f$usuari)
      f$usuari<-as.factor(f$usuari)
    }
    
    #canviar
    if (idioma_movil=="x" | any(!complete.cases(f)) | nrow(f) < nrow(estructura_false)| length(unique(f$usuari))>256){
      
      f<-"problema_xat"
      
      
    }else{
      
      cat("SUCCESS!!!!")
      
      xat<-f
      #-------------------------------------- FEM ELS Analytics
    
      #canvi en el progr'es
      progress$inc(amount = 1/5, detail = "Preparant Analytics!")
      
      #creem el directori on anira tot
      dir.create(tmp <- tempfile())
      
      #crea una ruta del zip
      zipfile <- file
      
      #Idioma de l'Analytics
      idioma= input$idioma_analytics
      if (idioma=="val"){

        out <- rmarkdown::render('Analytics_PRO_val.Rmd',
                      output_dir = tmp )
        
        file.rename(out, file.path(tmp,"Analytics PRO.html"))
        
        
        zip::zip(zipfile, "Analytics PRO.html", root = tmp)
        #zip_append(zipfile, file.path( "Tangible x"), root = tmp)
        
      }else if(idioma=="cast"){
        
        out <- rmarkdown::render('Analytics_PRO_cast.Rmd',
                      output_dir = tmp )
        
        file.rename(out, file.path(tmp,"Analytics PRO.html"))
        
        
        zip::zip(zipfile, "Analytics PRO.html", root = tmp)
        
      }else{}
      
      
      #------------------------ CREACIO DE LES IMATGES TANGIBLE
      
      progress$inc(amount = 1/5, detail = "Creant les imatges que has demanat!")
      
      #deixem sols 6 columnes del xat.
      xat<-xat[,1:6]
      
      tria<-get_tria(input)
      #creem les imatges depenent de les demandes que fa
      for (x in str_split(tria, "-")[[1]][str_split(tria, "-")[[1]]!=""]){
        cat(x, "-\n")
        
        fer_imatges(xat, x, tmp,zipfile)
      }
      
      
      
      
      
      progress$inc(amount = 1/5, detail = "Enviant-te la comanda al correu!")
      

      
    return(zipfile)
  
    }
}


```



```{r}

msg<-reactiveVal("HOLAQUE TAL")
  

runApp(list(
  ui = pageWithSidebar(
      headerPanel("Test"),
         sidebarPanel(
           tags$head(tags$style(type="text/css", "
             #loadmessage {
               position: fixed;
               top: 20%;
               left: 25%;
               width: 50%;
               height: 63px;
               padding: 5px 0px 5px 0px;
               text-align: center;
               font-weight: bold;
               font-size: 100%;
               color: #000000;
               background-color: #CCFF66;
               z-index: 105;
             }
          ")),
           numericInput('n', 'Number of obs', 100),
           conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                            tags$div("Espera!
                                     
                                     POt tardar 2 minuts!",id="loadmessage"))
         ),
         mainPanel(plotOutput('plot'))
  ),
  server = function(input, output) {
    
    output$msg<-renderText(
    "HOLA")
    
    output$plot <- renderPlot({ Sys.sleep(2); hist(runif(input$n)) })
    
    output$msg<-renderText(
    "EI QUE PASSA")
    
    output$plot <- renderPlot({ Sys.sleep(2); hist(runif(input$n)) })
    
  }
))

```


```{r}
library(shiny)
library(waiter)

ui <- fluidPage(
  use_waiter(), # include dependencies
  actionButton("show", "Show loading for 3 seconds")
)

server <- function(input, output, session){

  observeEvent(input$show, {

    waiter_show( # show the waiter
      html = tagList(
        spin_fading_circles(),
        "Loading ..."
      ), # use a spinner
      logo="./needs/logo.png"
    )

    Sys.sleep(3) # do something that takes time
    
    waiter_hide() # hide the waiter
  })
  
}

shinyApp(ui, server)
```

```{r}
library(shiny)
library(waiter)

ui <- fluidPage(
  use_waiter(),
  actionButton("show", "Show loading with updates")
)

server <- function(input, output, session){
  # create the waiter
  w <- Waiter$new(
    #html = span("Initialising"),
    html = tagList(spin_google(), tags$span(style="color:#831923", "Loading...")),
    color = transparent(.5))

  msgs <- c("Loading data", "Running model", "Drawing plots")

  observeEvent(input$show, {
    w$show()

    Sys.sleep(2)
    
    w$update(html = tagList(spin_2(),tags$br(),  tags$span(style="color:#831923", "HOLA!!!")))
    Sys.sleep(200)
    
   
    

    w$hide()
  })
}

shinyApp(ui, server)


```

